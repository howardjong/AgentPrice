# Jest to Vitest Migration Plan

## Overview

This document outlines the plan for migrating our test suite from Jest to Vitest. The migration is needed to:

1. Improve compatibility with ES modules
2. Reduce memory usage during test runs
3. Improve test performance
4. Consolidate redundant test code

## Migration Strategy

### Phase 1: Preparation (Complete)

- [x] Create shared test utilities in `tests/utils/test-helpers.js`
- [x] Implement Vitest configuration in `vitest.config.js`
- [x] Create global setup file in `tests/vitest.setup.js`
- [x] Develop migration tools:
  - [x] `scripts/migrate-test-file.js` - Convert Jest test files to Vitest
  - [x] `scripts/track-migration-progress.js` - Track and report migration progress
  - [x] `scripts/selective-test-runner.js` - Run and compare tests across frameworks
  - [x] `scripts/run-vitest.js` - Optimized Vitest runner

### Phase 2: Core Services Migration (Complete)

- [x] Migrate integration test: `tests/integration/workflow/research.vitest.js`
- [x] Migrate service tests:
  - [x] `tests/unit/services/perplexityService.vitest.js`
  - [x] `tests/unit/services/anthropicService.vitest.js`
  - [x] `tests/unit/services/serviceRouter.vitest.js`
  - [x] `tests/unit/services/contextManager.vitest.js`
  - [x] `tests/unit/services/jobManager.vitest.js`
- [x] Migrate utility tests:
  - [x] `tests/unit/utils/circuitBreaker.vitest.js`
  - [x] `tests/unit/utils/logger.vitest.js`
  - [x] `tests/unit/utils/apiClient.vitest.js`
  - [x] `tests/unit/utils/smartCache.vitest.js`
  - [x] `tests/unit/utils/resourceManager.vitest.js`

### Phase 3: Feature-specific Tests (Complete)

- [x] Migrate visualization tests
- [x] Migrate API endpoint tests
- [x] Migrate cost optimization tests

### Phase 4: Performance Tests (Complete)

- [x] Migrate memory usage tests
- [x] Migrate throughput tests

## Migration Progress

See detailed progress in `TEST_MIGRATION_PROGRESS.md`, automatically generated by our tracking script. Currently, we have achieved 100% migration of all test files.

## Memory Optimization

Each test file follows these best practices to prevent memory issues:

1. Use mocking patterns that avoid ESM teardown issues
2. Reset mocks in `beforeEach` and `afterEach` hooks
3. Clean up resources effectively
4. Use the `traceTest` utility to monitor memory usage
5. Run tests in optimized batches for better resource management

## Code Consolidation

Throughout the migration process, we've consolidated redundant code:

1. Used shared mock factories from `test-helpers.js`
2. Standardized setup/teardown patterns
3. Implemented consistent mocking approaches with proper hoisting behavior
4. Removed duplicate test implementations
5. Created a mocking guide to ensure consistency

## Testing Approach

To ensure the migration doesn't introduce regressions:

1. Both Jest and Vitest versions produce the same test results
2. We've used the `selective-test-runner.js` script to compare results
3. We've fixed the known ES module issues that existed in Jest

## Resolved Issues

- Fixed mock implementation for Vitest's hoisting behavior
- Implemented proper ES module path handling
- Created optimized resource management between test runs
- Created documentation for consistent mocking patterns

## Next Steps

1. Continue monitoring test performance
2. Consider further memory optimizations
3. Add more comprehensive tests for new features
4. Develop automation for continuous test execution

See comprehensive details in the `tests/MIGRATION_SUMMARY.md` document.